<!DOCTYPE html>
<html>
    <head>
       <meta charset="utf-8">
       <title>Guesswhat backend api</title>
       <script src="/socket.io/socket.io.js"></script>
       <script src="/categoriesEnum.js"></script>
    </head>
    <body>
        <!-- ROW HTML-->
        <h1>Hi welcome to guesswhat api tester</h1>
        <button onclick="getCategories()">getCategories (look in logs)</button>
        <hr>
        <b>Create private room</b><br>
        <label for="categoriesSelect">Category:</label>
        <select class="categoriesSelect" id="privateRoomCategoriesSelect"></select>
        <button onclick="getPrivateRoomId()">getPrivateRoomId</button>
        <input readonly type="text" id="privateRoomId">
        <button onclick="createPrivateRoom()">createPrivateRoom</button>
        <hr>
        <b>Join private room</b><br>
        <input type="text" id="privateRoomIdToJoin">
        <button onclick="joinPrivateRoom()">joinPrivateRoom</button>
        <hr>
        <b>Join public room</b><br>
        <label for="categoriesSelect">Category:</label>
        <select class="categoriesSelect"  id="publicRoomCategoriesSelect"></select>
        <button onclick="getRoomsByCategory()">getRoomsByCategory</button>
        <ul id='categoryList'>
        </ul>
        <textarea rows=5 readonly id='roomPlayersUpdates'></textarea>
        <br>
        <input type="text" id="roomId">
        <button onclick="joinRoom()">joinRoom</button>
        <hr>
        <br>
        <br>
        <div id="room" style='border-style:solid;display:none; padding:10px'>
            <p style="text-align: center;" id='roomTitle'>Room : none</p>
            <br>
            <br>
            <div style="display:inline;
            text-align:center; ">

            <div style="display: inline-block;
            vertical-align: top;
            border: 2px solid black;
            position: relative; height:400px; width:60%; margin-left: 10px; margin-bottom: 10px;">
                <img style="position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                right: 0;
                margin: auto; max-height: 350px; max-width: 400px;" src="" alt="Loading..." id='image'>
            </div>
            <div style="float:left; height:400px; width:17.5%;
            margin-left: 10px; margin-right: 10px; margin-bottom: 20px;">
                <div style="margin-top: 10px;">
                    <button onclick="leaveRoom()">Leave Room</button>
                </div>
                <div style="margin-top: 10px; height:300px;
                border:2px solid black;overflow-y: scroll;"
                readonly id='playerList'></div>
                <div style="margin-top: 10px;">
                    <button onclick="startPrivateGame()">startPrivateGame</button>
                    <button onclick="voteToSkip()" id="skipButton">Skip</button>
                </div>

            </div>
            <div style="float:right; height:400px; width:17.5%;
            margin-left: 10px; margin-right: 10px; margin-bottom: 20px;">
                <div rows=8 readonly id='chat'
                style="height:350px; border:2px solid black;overflow-y: scroll;">
                </div>
                <div style="margin-top:15px; ">
                    <input type="text" id='messageInput'>
                    <button onclick="submitMessage()">Send</button>
                </div>
            </div>
        </div>


        </div>

        <!-- JAVASCRIPT -->
        <script type="text/javascript">
            var socket = io();

            var roomId;
            //categories initialization
            var selects = document.getElementsByClassName('categoriesSelect');
            Object.entries(selects).map((select) => {
                for(var category of Object.values(CategoriesEnum)){
                    var item = document.createElement('option');
                    item.value = category;
                    item.innerHTML = category;
                    select[1].appendChild(item);
                }
            });


            //Events------------------------------------------------------------------------

	    	socket.on('connect', function(){
	    		console.log("connected");
            });


            socket.on('joinRoomResponse', function(data){
	    		if(data.error === true){
                    alert(data.message)
                }else{
                    roomId = data.room;
                    alert(`joining room ${data.room}`);
                    document.getElementById("room").style.display = 'block';
                    document.getElementById("chat").style.innerHTML = '';
                    document.getElementById('roomTitle').innerHTML = `Room : ${data.room}`;
                }
            });

            socket.on('roomsByCategory', function(data){
                var list = document.getElementById('categoryList');
                list.innerHTML = '';
                for(var room of data.rooms){
                    var item = document.createElement('li');
                    item.innerHTML = `id: ${room.id} | players : ${room.nbPlayers}/${room.playerLimit} | category: ${room.category}`
                    list.appendChild(item);
                }

            });


            socket.on('imageUpdate', function(data){
                document.getElementById("image").src = data.image;
            });

            socket.on('message', function(data){
                var messageDiv = document.createElement("div");
                messageDiv.innerHTML = data.message.playerUsername +" : "+data.message.text;
                messageDiv.setAttribute("style","width:auto");
                if(data.message.valid == true)
                    messageDiv.style.backgroundColor = 'green';

                var chat = document.getElementById("chat");
                chat.appendChild(messageDiv);
                chat.scrollTop = chat.scrollHeight;
            });

            socket.on('pointUpdate', function(data){
                document.getElementById("playerList").innerHTML += JSON.stringify(data);
            });

            socket.on('playerJoined', function(data){
                var messageDiv = document.createElement("div");
                messageDiv.innerHTML = data.playerUsername +" joined the game";
                messageDiv.setAttribute("style","font-style:italic;");
                var chat = document.getElementById("chat");
                chat.appendChild(messageDiv);
                chat.scrollTop = chat.scrollHeight;
            });

            socket.on('playerLeft', function(data){
                var messageDiv = document.createElement("div");
                messageDiv.innerHTML = data.playerUsername +" left the game";
                messageDiv.setAttribute("style","font-style:italic;");
                var chat = document.getElementById("chat");
                chat.appendChild(messageDiv);
                chat.scrollTop = chat.scrollHeight;
            });

            socket.on('playerList', function(data){
                document.getElementById("playerList").innerHTML = JSON.stringify(data);
            });

            socket.on('playerVotedToSkip', function(data){
                var messageDiv = document.createElement("div");
                messageDiv.innerHTML = data.username + " voted to skip ("+data.skipCount+"/"+data.playerCount+")";
                messageDiv.setAttribute("style","font-style:italic;");
                var chat = document.getElementById("chat");
                chat.appendChild(messageDiv);
                chat.scrollTop = chat.scrollHeight;
            });

            socket.on('newRoundStarting', function(){
                var messageDiv = document.createElement("div");
                messageDiv.innerHTML = "New round starting";
                messageDiv.setAttribute("style","font-style:italic;");
                var chat = document.getElementById("chat");
                chat.appendChild(messageDiv);
                chat.scrollTop = chat.scrollHeight;
                document.getElementById("skipButton").disabled = false;
            });

            socket.on('roomPlayersUpdate', function(data){
                document.getElementById("roomPlayersUpdates").innerHTML += JSON.stringify(data);
            });

            socket.on('privateRoomId', function(data){
                document.getElementById("privateRoomId").value = data.roomId;
            });

            socket.on('categories', function(data){
                console.log(data)
            });

            //Actions------------------------------------------------------------------------

            function getRoomsByCategory(){
                var e = document.getElementById("publicRoomCategoriesSelect");
                var selectedCategory = e.options[e.selectedIndex].text;
                socket.emit('getRoomsByCategory',{ category : selectedCategory});
            }


            function joinRoom(){
                var roomId = document.getElementById("roomId").value.trim();
                if(roomId === '')
                    alert('Id is missing')
                else {
                    var username = prompt(`Please enter your username to join room : ${roomId}`, "");
                    if (username.trim().length>0) {
                        socket.emit('joinRoom',{ roomId : roomId, username : username});
                    }else{
                        alert('Username is missing')
                    }
                }
            }

            function leaveRoom(){
                document.getElementById("image").src = '';
                document.getElementById('roomTitle').innerHTML = 'Room : none';
                socket.emit('leaveRoom',{ roomId : roomId});
                document.getElementById("room").style.display = "none";
            }

            function submitMessage(){
                let input = document.getElementById('messageInput');
                let text = input.value.trim();
                input.value = '';
                if(text.length > 0){
                    let message = {
                        roomId : roomId,
                        text : text
                    }
                    socket.emit('submitMessage',message);
                }
            }

            function voteToSkip(){
                let message = {
                        roomId : roomId
                }
                socket.emit('voteToSkip',message);
                document.getElementById("skipButton").disabled = true;
            }

            function getPrivateRoomId(){
                socket.emit('getPrivateRoomId');
            }

            function createPrivateRoom(){
                var e = document.getElementById("privateRoomCategoriesSelect");
                let selectedCategory = e.options[e.selectedIndex].text;
                let roomId = document.getElementById("privateRoomId").value;
                let username = prompt(`Please enter your username to join private room : ${roomId}`, "");
                if (username.trim().length>0) {
                    let message = {
                        category : selectedCategory,
                        roomId : roomId,
                        username : username
                    }
                    socket.emit('createPrivateRoom',message);
                }else{
                    alert('Username is missing')
                }
            }

            function startPrivateGame(){
                let message = {
                        roomId : roomId
                    }
                socket.emit('startPrivateGame',message);
            }

            function joinPrivateRoom(){
                var roomId = document.getElementById("privateRoomIdToJoin").value.trim();
                if(roomId === '')
                    alert('Id is missing')
                else {
                    var username = prompt(`Please enter your username to join the private room : ${roomId}`, "");
                    if (username.trim().length>0) {
                        socket.emit('joinRoom',{ roomId : roomId, username : username});
                    }else{
                        alert('Username is missing')
                    }
                }
            }

            function getCategories(){
                socket.emit('getCategories');
            }

        </script>
    </body>
</html>
